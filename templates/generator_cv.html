{% extends 'base.html' %}

{% block content %}
<section class="py-5 bg-soft-blue" style="min-height: 100vh;">
    <div class="container py-lg-4">
        <div class="text-center mb-5 animate-text">
            <h1 class="fw-bold" style="color: var(--primary-navy);">Generator CV Minimalis</h1>
            <p class="text-muted">Buat CV profesional dengan desain bersih dan elegan.</p>
        </div>

        <div class="row g-4 justify-content-center">
            <!-- ================= FORM INPUT (KIRI) ================= -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-premium p-4 rounded-4 animate-text" style="max-height: 85vh; overflow-y: auto;">
                    <h5 class="fw-bold mb-4 text-dark"><i class="me-2">‚úçÔ∏è</i> Isi Data Diri</h5>
                    
                    <div class="mb-4 text-center">
                        <label class="form-label small fw-bold d-block text-start">Foto Profil</label>
                        <input type="file" id="inFoto" class="form-control mb-2" accept="image/*" onchange="previewImage(this)">
                        <small class="text-muted d-block text-start" style="font-size: 0.75rem;">Gunakan foto formal rasio 1:1</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Nama Lengkap</label>
                        <input type="text" id="inNama" class="form-control" placeholder="Cth: Dani Schwaiger" oninput="updatePreview()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Jabatan / Posisi</label>
                        <input type="text" id="inJabatan" class="form-control" placeholder="Cth: Web Developer" oninput="updatePreview()">
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">No. WhatsApp</label>
                            <input type="text" id="inHp" class="form-control" placeholder="08..." oninput="updatePreview()">
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Email</label>
                            <input type="email" id="inEmail" class="form-control" placeholder="nama@email.com" oninput="updatePreview()">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Alamat Domisili</label>
                        <input type="text" id="inAlamat" class="form-control" placeholder="Cth: Jakarta Selatan" oninput="updatePreview()">
                    </div>

                    <hr class="my-4">

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Profil Singkat</label>
                        <textarea id="inProfil" class="form-control" rows="3" placeholder="Deskripsikan diri Anda secara profesional..." oninput="updatePreview()"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Riwayat Pendidikan</label>
                        <textarea id="inEdu" class="form-control" rows="3" placeholder="2014 - 2018 : Universitas Indonesia" oninput="updatePreview()"></textarea>
                        <div class="form-text small">Format: Tahun : Sekolah</div>
                    </div>

                    <!-- Input Baru: Pengalaman -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Pengalaman Kerja</label>
                        <textarea id="inExp" class="form-control" rows="3" placeholder="2019 - 2021 : Staff Admin di PT. Maju Jaya" oninput="updatePreview()"></textarea>
                        <div class="form-text small">Format: Tahun : Posisi & Perusahaan</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold">Keahlian (Pisahkan koma)</label>
                        <input type="text" id="inSkill" class="form-control" placeholder="Microsoft Office, English, Python" oninput="updatePreview()">
                    </div>

                    <button type="button" id="btnDownload" class="btn btn-navy w-100 rounded-pill py-3 fw-bold shadow mt-2" onclick="generatePDF()">
                        üì• Download PDF
                    </button>
                </div>
            </div>

 <!-- ...existing code... -->
            <!-- ================= PREVIEW TEMPLATE (KANAN) ================= -->
            <div class="col-lg-8">
                <div class="preview-container bg-secondary bg-opacity-10 p-4 rounded-4" style="overflow: hidden;">
                    
                    <!-- KERTAS A4 -->
                    <!-- PERBAIKAN: Ditambahkan 'text-align: left' pada style -->
                    <div id="cvTemplate" class="shadow-lg mx-auto" style="width: 210mm; min-height: 297mm; background: white; padding: 50px 40px; color: #1e293b; font-family: 'Poppins', sans-serif; position: relative; box-sizing: border-box; text-align: left;">
                        
                        <!-- HEADER SECTION -->
                        <div class="d-flex align-items-center mb-5 pb-4 border-bottom border-2">
                            <!-- Foto -->
                            <div class="me-4 flex-shrink-0 position-relative">
                                <div style="width: 140px; height: 140px; border-radius: 50%; overflow: hidden; border: 3px solid #1e293b;">
                                    <img id="outFoto" 
                                         src="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%23e2e8f0%22%3E%3Cpath%20d%3D%22M24%2024H0V0h24v24z%22%20fill%3D%22none%22/%3E%3Cpath%20d%3D%22M12%2012c2.21%200%204-1.79%204-4s-1.79-4-4-4-4%201.79-4%204%201.79%204%204%204zm0%202c-2.67%200-8%201.34-8%204v2h16v-2c0-2.66-5.33-4-8-4z%22%20fill%3D%22%2394a3b8%22/%3E%3C/svg%3E" 
                                         style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            </div>
                            
                            <!-- Nama & Kontak -->
                            <div class="flex-grow-1">
                                <h1 id="outNama" class="fw-bold text-uppercase mb-1" style="font-size: 2.5rem; letter-spacing: -1px; line-height: 1;">DANI SCHWAIGER</h1>
                                <p id="outJabatan" class="text-uppercase fw-semibold mb-4" style="letter-spacing: 3px; font-size: 0.9rem; color: #64748b;">WEB DEVELOPER</p>
                                
                                <div class="row g-2 small text-muted">
                                    <div class="col-auto d-flex align-items-center">
                                        <span class="me-1">üìû</span> <span id="outHp">0812-3456-7890</span>
                                    </div>
                                    <div class="col-auto text-secondary">|</div>
                                    <div class="col-auto d-flex align-items-center">
                                        <span class="me-1">‚úâÔ∏è</span> <span id="outEmail">hello@email.com</span>
                                    </div>
                                </div>
                                <div class="small text-muted mt-1 d-flex align-items-center">
                                    <span class="me-1">üìç</span> <span id="outAlamat">Jakarta, Indonesia</span>
                                </div>
                            </div>
                        </div>

                        <!-- BODY CONTENT (TIMELINE STYLE) -->
                        <div class="ps-3 position-relative" style="border-left: 2px solid #e2e8f0; margin-left: 20px;">
                            
                            <!-- 1. PROFIL -->
                            <div class="mb-5 position-relative ps-4">
                                <div class="position-absolute bg-white border border-2 border-dark rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px; left: -41px; top: 0; color: #1e293b;">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
                                </div>
                                <h5 class="fw-bold text-uppercase mb-3" style="letter-spacing: 1px; font-size: 1rem;">Profil</h5>
                                <!-- PERBAIKAN: Ubah text-align: justify menjadi left -->
                                <p id="outProfil" style="font-size: 0.95rem; line-height: 1.6; color: #475569; text-align: left;">
                                    Saya adalah seorang profesional yang berdedikasi tinggi dengan pengalaman di bidang teknologi. Mampu bekerja dalam tim maupun individu dengan baik.
                                </p>
                            </div>

                            <!-- 2. PENDIDIKAN -->
                            <div class="mb-5 position-relative ps-4">
                                <div class="position-absolute bg-white border border-2 border-dark rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px; left: -41px; top: 0; color: #1e293b;">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-mortarboard-fill" viewBox="0 0 16 16"><path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5Z"/><path d="M4.176 9.032a.5.5 0 0 0-.656.327l-.5 1.7a.5.5 0 0 0 .294.605l4.5 1.8a.5.5 0 0 0 .372 0l4.5-1.8a.5.5 0 0 0 .294-.605l-.5-1.7a.5.5 0 0 0-.656-.327L8 10.466 4.176 9.032Z"/></svg>
                                </div>
                                <h5 class="fw-bold text-uppercase mb-3" style="letter-spacing: 1px; font-size: 1rem;">Pendidikan</h5>
                                <div id="outEdu" style="font-size: 0.95rem; line-height: 1.8; color: #475569; white-space: pre-line;">
                                    2014 - 2018 : Universitas Contoh Bangsa
                                    2011 - 2014 : SMA Negeri 1 Kota
                                </div>
                            </div>

                            <!-- 3. PENGALAMAN -->
                            <div class="mb-5 position-relative ps-4">
                                <div class="position-absolute bg-white border border-2 border-dark rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px; left: -41px; top: 0; color: #1e293b;">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-briefcase-fill" viewBox="0 0 16 16"><path d="M6.5 1A1.5 1.5 0 0 0 5 2.5V3H1.5A1.5 1.5 0 0 0 0 4.5v1.384l7.614 2.03a1.5 1.5 0 0 0 .772 0L16 5.884V4.5A1.5 1.5 0 0 0 14.5 3H11v-.5A1.5 1.5 0 0 0 9.5 1h-3zm0 1h3a.5.5 0 0 1 .5.5V3H6v-.5a.5.5 0 0 1 .5-.5z"/><path d="M0 12.5A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5V6.85L8.129 8.947a.5.5 0 0 1-.258 0L0 6.85v5.65z"/></svg>
                                </div>
                                <h5 class="fw-bold text-uppercase mb-3" style="letter-spacing: 1px; font-size: 1rem;">Pengalaman</h5>
                                <div id="outExp" style="font-size: 0.95rem; line-height: 1.8; color: #475569; white-space: pre-line;">
                                    2020 - Sekarang : Web Developer di PT Tech Maju
                                    2018 - 2019 : Intern di CV Kreatif Digital
                                </div>
                            </div>

                            <!-- 4. KEMAMPUAN -->
                            <div class="mb-5 position-relative ps-4">
                                <div class="position-absolute bg-white border border-2 border-dark rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px; left: -41px; top: 0; color: #1e293b;">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.86z"/></svg>
                                </div>
                                <h5 class="fw-bold text-uppercase mb-3" style="letter-spacing: 1px; font-size: 1rem;">Kemampuan</h5>
                                <ul id="outSkill" class="ps-3 mb-0" style="color: #475569; font-size: 0.95rem;">
                                    <li>Belum ada skill ditambahkan</li>
                                </ul>
                            </div>

                        </div>
                        
                        <!-- Footer watermark -->
                        <div class="text-center mt-5 pt-5 opacity-25 border-top w-75 mx-auto">
                            <p class="small mb-0">Generated by KARDIGI.com</p>
                        </div>
                    </div>
                </div>
            </div>
</section>

<!-- Modal Upsell -->
<div class="modal fade" id="modalUpsell" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4 border-0 rounded-4 shadow-lg">
            <div class="modal-body">
                <div class="display-1 mb-3">üéâ</div>
                <h3 class="fw-bold">CV Berhasil Dikutip!</h3>
                <p class="text-muted mb-4">Mau template yang lebih Premium & Lolos ATS?</p>
                <a href="https://wa.me/6289509951772?text=Halo%20Admin%20KARDIGI,%20saya%20mau%20upgrade%20CV%20Premium" target="_blank" class="btn btn-orange w-100 rounded-pill py-3 fw-bold mb-2">Upgrade Premium Rp 20rb ‚ûú</a>
                <button type="button" class="btn btn-link text-muted small" data-bs-dismiss="modal">Nanti Saja</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // --- 1. PREVIEW FOTO ---
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('outFoto').src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 2. UPDATE PREVIEW ---
    function updatePreview() {
        // Basic Info
        const setVal = (id, def) => document.getElementById(id).innerText = document.getElementById(id.replace('out','in')).value || def;
        
        setVal('outNama', 'DANI SCHWAIGER');
        setVal('outJabatan', 'WEB DEVELOPER');
        setVal('outHp', '0812-3456-7890');
        setVal('outEmail', 'hello@email.com');
        setVal('outAlamat', 'Jakarta, Indonesia');
        setVal('outProfil', 'Deskripsi profesional Anda akan muncul di sini. Tuliskan profil singkat yang menarik.');
        setVal('outEdu', '2014 - 2018 : Universitas Contoh\n2011 - 2014 : SMA Negeri 1');
        setVal('outExp', '2019 - Sekarang : Posisi di Perusahaan\n2018 - 2019 : Posisi Lama');

        // Skill List
        const rawSkill = document.getElementById('inSkill').value;
        const skills = rawSkill.split(',').filter(s => s.trim().length > 0);
        const listContainer = document.getElementById('outSkill');
        
        if (skills.length > 0) {
            listContainer.innerHTML = skills.map(s => `<li>${s.trim()}</li>`).join('');
        } else {
            listContainer.innerHTML = '<li>Keahlian 1</li><li>Keahlian 2</li>';
        }
    }

    // --- 3. GENERATE PDF (SAFE OVERLAY MODE) ---
    async function generatePDF() {
        updatePreview();
        
        const btn = document.getElementById('btnDownload');
        const oldText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Memproses...";
        btn.disabled = true;

        const original = document.getElementById('cvTemplate');
        
        // Buat container overlay putih penuh
        const container = document.createElement('div');
        Object.assign(container.style, {
            position: 'fixed', top: '0', left: '0',
            width: '100vw', height: '100vh',
            zIndex: '99999', background: 'white',
            display: 'flex', justifyContent: 'center', paddingTop: '20px'
        });

        const loadingMsg = document.createElement('div');
        loadingMsg.innerHTML = '<h4 style="margin-top:20px;">Mencetak CV...</h4>';
        loadingMsg.style.position = 'absolute'; loadingMsg.style.bottom = '20px';
        container.appendChild(loadingMsg);

        // Grid Cloner
        const clone = original.cloneNode(true);
        clone.style.transform = 'none';
        clone.style.margin = '0';
        
        // Sync Gambar
        const originImg = original.querySelector('#outFoto');
        const cloneImg = clone.querySelector('#outFoto');
        if(originImg && cloneImg) cloneImg.src = originImg.src;

        container.appendChild(clone);
        document.body.appendChild(container);

        // Wait render
        await new Promise(r => setTimeout(r, 800));

        const opt = {
            margin: 0,
            filename: `CV_${document.getElementById('inNama').value || 'User'}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            await html2pdf().set(opt).from(clone).save();
        } catch (e) {
            console.error(e);
            alert("Gagal Save PDF");
        } finally {
            document.body.removeChild(container);
            btn.innerHTML = oldText;
            btn.disabled = false;
            
            if(window.bootstrap) {
                const modal = new bootstrap.Modal(document.getElementById('modalUpsell'));
                modal.show();
            }
        }
    }
</script>

<style>
    .btn-navy { background-color: var(--primary-navy); color: white; transition: 0.3s; }
    .btn-navy:hover { background-color: #1e293b; transform: translateY(-2px); }
    
    /* PC / Laptop Styles */
    @media (min-width: 992px) { 
        .preview-container { text-align: center; overflow: hidden; }
        #cvTemplate { 
            transform: scale(0.60); 
            transform-origin: top center; 
            margin-bottom: -450px; 
        } 
    }

    /* Mobile / Tablet Styles */
    @media (max-width: 991px) { 
        .preview-container {
            /* Gunakan Flexbox untuk memaksa elemen ke tengah */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Mulai dari atas */
            
            overflow: hidden; /* Hilangkan scrollbar horizontal & vertical berlebih */
            padding-top: 25px;
            
            /* Tinggi fix agar tidak ada whitespace raksasa di bawah */
            height: 550px; 
            background: #f8fafc; /* Sedikit shading agar kertas terlihat */
        }

        #cvTemplate { 
            /* Scale 0.40 pas untuk lebar HP rata-rata (350-400px) */
            transform: scale(0.40); 
            transform-origin: top center; 
            
            /* Reset Margin agar Flexbox bekerja sempurna */
            margin: 0 !important;
            
            /* Bayangan diperhalus untuk mobile */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        }
    }
</style>
{% endblock %}